<?php
/*
 * Implementing hook_permission
 */
function copycat_permission(){
   return array(
    'use copycat' => array(
      'title' => t('Edit content inline'), 
      'description' => t('Use copycat for inline editting.'),
    ),
  );
}

/** Implementing hook_menu
 *
 * @return array 
 */
function copycat_menu(){
  $items = array();
  $items['copycat'] = array(
    'page callback' => 'copycat_edit',
    'access arguments' => array('use copycat'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

function copycat_edit(){
  $op = isset($_GET['op']) ? $_GET['op'] : FALSE;
  $copy = isset($_GET['copy']) ? $_GET['copy'] : FALSE;
  $nid = isset($_GET['nid']) ? $_GET['nid'] : FALSE;
  switch($op) {
    case 'get-form': 
      $form = drupal_get_form('copycat_form', array($copy, $nid));
      $form = drupal_render($form);
      return $form;
      break;
    default:
      $form = drupal_get_form('copycat_form', array('test', 19));
      $form = drupal_render($form);
      return($form);
  }
  
}

function copycat_form($form_state, $args){
 $form['copy'] = array(
      '#type' => 'textarea',
      '#rows' => 2,
      '#default_value' => $args['build_info']['args'][0][0],
  );
  $form['original_copy'] = array(
      '#type' => 'value',
      '#value' => $args['build_info']['args'][0][0],
  );
  $form['nid'] = array(
      '#type' => 'value',
      '#value' => $args['build_info']['args'][0][1],
  );
  $form['submit'] = array(
      '#type' => 'button',
      '#value' => t('Save changes'),
      '#ajax' => array(
        'callback' => 'ajax_replace_form_callback',
        'name' => 'submit_ajax',
        'event' => 'click',
    ),
  );


  return $form;
}

function ajax_replace_form_callback(&$form, &$form_state) {
  $commands = array();
  $commands[] = ajax_command_replace('#copycat-form', '<div>'.$form_state['values']['copy'].'</div>');
  return array('#type' => 'ajax', '#commands' => $commands);

}

function copycat_preprocess_page(&$vars){
  if(arg(0) == 'copycat'){
    $vars['theme_hook_suggestion'] = "copycat_content_only";
  }
}

/**
 * Implementing hook_theme
 * @return type
 */
function copycat_theme() {
  $info = array();
  $info["copycat_content_only"] = array(
    'template' => 'copycat_content_only',
    'path' => drupal_get_path('module', 'copycat'),
  );
  return $info;
}